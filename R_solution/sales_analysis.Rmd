---
title: "Sales Analytics Dashboard"
subtitle: "SQL Server Express Analysis"
author: "Sales Analytics Team"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    code_folding: hide
    fig_width: 12
    fig_height: 8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  message = FALSE, 
  warning = FALSE,
  fig.align = "center"
)
```

# Executive Summary

This report analyzes sales performance and customer data from our SQL Server Express database, focusing on:

- Monthly sales trends over the last 12 months
- Top 10 customers by total purchases
- Key performance indicators and insights

---

## Setup and Database Connection

```{r libraries}
# Load required libraries
library(DBI)
library(odbc)
library(dplyr)
library(ggplot2)
library(plotly)
library(htmlwidgets)
library(lubridate)
library(scales)
library(htmltools)
library(RColorBrewer)
library(knitr)
library(DT)

# Set theme for all ggplot2 charts
theme_set(theme_minimal())
```

```{r database_config}
# Database connection configuration
# ‚ö†Ô∏è UPDATE THESE VARIABLES WITH YOUR SQL SERVER EXPRESS DETAILS
server_name <- "localhost\\SQLEXPRESS"  # Update with your server name
database_name <- "YourDatabase"         # Update with your database name
username <- ""                          # Leave empty for Windows Authentication
password <- ""                          # Leave empty for Windows Authentication

# Create connection string
if (username == "" && password == "") {
  # Windows Authentication
  connection_string <- paste0(
    "Driver={ODBC Driver 17 for SQL Server};",
    "Server=", server_name, ";",
    "Database=", database_name, ";",
    "Trusted_Connection=yes;"
  )
} else {
  # SQL Server Authentication
  connection_string <- paste0(
    "Driver={ODBC Driver 17 for SQL Server};",
    "Server=", server_name, ";",
    "Database=", database_name, ";",
    "UID=", username, ";",
    "PWD=", password, ";"
  )
}
```

```{r connect_database}
# Function to connect to database
connect_to_db <- function() {
  tryCatch({
    con <- dbConnect(odbc::odbc(), .connection_string = connection_string)
    message("‚úÖ Successfully connected to SQL Server!")
    return(con)
  }, error = function(e) {
    stop("‚ùå Failed to connect to database: ", e$message)
  })
}

# Establish connection
con <- connect_to_db()
```

---

## Data Extraction

```{r sql_queries}
# SQL Queries - Adapt these to your actual table structure

# Query for monthly sales over 12 months
sales_query <- "
SELECT 
    YEAR(OrderDate) as Year,
    MONTH(OrderDate) as Month,
    DATENAME(MONTH, OrderDate) + ' ' + CAST(YEAR(OrderDate) AS VARCHAR(4)) as MonthYear,
    SUM(TotalAmount) as TotalSales,
    COUNT(*) as OrderCount,
    AVG(TotalAmount) as AvgOrderValue
FROM Orders 
WHERE OrderDate >= DATEADD(MONTH, -12, GETDATE())
GROUP BY YEAR(OrderDate), MONTH(OrderDate), DATENAME(MONTH, OrderDate)
ORDER BY Year, Month
"

# Query for top 10 customers
customers_query <- "
SELECT TOP 10
    c.CustomerID,
    c.CustomerName,
    SUM(o.TotalAmount) as TotalPurchases,
    COUNT(o.OrderID) as OrderCount,
    AVG(o.TotalAmount) as AvgOrderValue,
    MIN(o.OrderDate) as FirstOrder,
    MAX(o.OrderDate) as LastOrder
FROM Customers c
INNER JOIN Orders o ON c.CustomerID = o.CustomerID
WHERE o.OrderDate >= DATEADD(MONTH, -12, GETDATE())
GROUP BY c.CustomerID, c.CustomerName
ORDER BY TotalPurchases DESC
"
```

```{r extract_data}
# Extract data from database
sales_data <- dbGetQuery(con, sales_query)
customers_data <- dbGetQuery(con, customers_query)

# Data preprocessing
sales_data <- sales_data %>%
  mutate(
    MonthDate = as.Date(paste(Year, Month, "01", sep = "-")),
    MonthYear = factor(MonthYear, levels = MonthYear)
  ) %>%
  arrange(Year, Month)

customers_data <- customers_data %>%
  mutate(
    FirstOrder = as.Date(FirstOrder),
    LastOrder = as.Date(LastOrder),
    CustomerLifetime = as.numeric(LastOrder - FirstOrder)
  )

# Display data preview
cat("üìä Sales Data Preview:\n")
head(sales_data) %>% kable()

cat("\nüë• Customer Data Preview:\n")
head(customers_data) %>% kable()
```

---

## Sales Analysis

### Monthly Sales Trend

```{r sales_chart}
# Create interactive monthly sales chart
sales_plot <- ggplot(sales_data, aes(x = MonthDate, y = TotalSales)) +
  geom_line(color = "steelblue", size = 1.5) +
  geom_point(color = "darkblue", size = 3) +
  geom_area(alpha = 0.3, fill = "steelblue") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  scale_y_continuous(labels = dollar_format()) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12, color = "gray60")
  ) +
  labs(
    title = "Monthly Sales Trend - Last 12 Months",
    subtitle = paste("Total Sales:", dollar(sum(sales_data$TotalSales))),
    x = "Month",
    y = "Sales Amount",
    caption = paste("Generated on:", Sys.Date())
  )

# Convert to interactive plot
interactive_sales <- ggplotly(sales_plot, tooltip = c("x", "y")) %>%
  layout(
    title = list(text = "Monthly Sales Trend - Last 12 Months", 
                 font = list(size = 16))
  )

interactive_sales
```

### Sales Performance Summary

```{r sales_summary}
# Calculate key metrics
total_sales <- sum(sales_data$TotalSales)
avg_monthly_sales <- mean(sales_data$TotalSales)
total_orders <- sum(sales_data$OrderCount)
avg_order_value <- total_sales / total_orders

# Find best and worst months
best_month <- sales_data[which.max(sales_data$TotalSales), ]
worst_month <- sales_data[which.min(sales_data$TotalSales), ]

# Create summary table
summary_metrics <- data.frame(
  Metric = c("Total Sales (12 months)", "Average Monthly Sales", "Total Orders", 
             "Average Order Value", "Best Month", "Worst Month"),
  Value = c(
    dollar(total_sales),
    dollar(avg_monthly_sales),
    format(total_orders, big.mark = ","),
    dollar(avg_order_value),
    paste(best_month$MonthYear, "-", dollar(best_month$TotalSales)),
    paste(worst_month$MonthYear, "-", dollar(worst_month$TotalSales))
  )
)

kable(summary_metrics, caption = "Key Sales Metrics")
```

---

## Customer Analysis

### Top 10 Customers

```{r customers_chart}
# Create interactive customer chart
customers_plot <- ggplot(customers_data, aes(x = reorder(CustomerName, TotalPurchases), 
                                             y = TotalPurchases,
                                             text = paste("Orders:", OrderCount))) +
  geom_col(fill = "forestgreen", alpha = 0.8) +
  coord_flip() +
  scale_y_continuous(labels = dollar_format()) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12, color = "gray60"),
    axis.text.y = element_text(size = 10)
  ) +
  labs(
    title = "Top 10 Customers by Total Purchases",
    subtitle = "Last 12 months",
    x = "Customer",
    y = "Total Purchases"
  )

# Convert to interactive plot
interactive_customers <- ggplotly(customers_plot, tooltip = c("y", "text")) %>%
  layout(
    title = list(text = "Top 10 Customers by Total Purchases", 
                 font = list(size = 16))
  )

interactive_customers
```

### Customer Details Table

```{r customer_table}
# Create detailed customer table
customer_table <- customers_data %>%
  mutate(
    TotalPurchases = dollar(TotalPurchases),
    AvgOrderValue = dollar(AvgOrderValue),
    FirstOrder = format(FirstOrder, "%Y-%m-%d"),
    LastOrder = format(LastOrder, "%Y-%m-%d")
  ) %>%
  select(
    `Customer Name` = CustomerName,
    `Total Purchases` = TotalPurchases,
    `Order Count` = OrderCount,
    `Avg Order Value` = AvgOrderValue,
    `First Order` = FirstOrder,
    `Last Order` = LastOrder
  )

# Display as interactive table
datatable(customer_table, 
          caption = "Detailed Customer Analysis",
          options = list(pageLength = 10, scrollX = TRUE),
          class = "cell-border stripe")
```

---

## Key Insights & Recommendations

```{r insights}
# Calculate insights
growth_rate <- (sales_data$TotalSales[nrow(sales_data)] - sales_data$TotalSales[1]) / 
               sales_data$TotalSales[1] * 100

top_customer_share <- customers_data$TotalPurchases[1] / total_sales * 100
top_3_customer_share <- sum(customers_data$TotalPurchases[1:3]) / total_sales * 100

cat("üîç KEY INSIGHTS:\n\n")
cat("üìà Sales Growth: The latest month compared to 12 months ago shows a", 
    round(growth_rate, 1), "% change\n\n")
cat("üëë Customer Concentration: Top customer represents", 
    round(top_customer_share, 1), "% of total sales\n\n")
cat("üéØ Top 3 customers represent", 
    round(top_3_customer_share, 1), "% of total sales\n\n")
```

### Recommendations

1. **Sales Trend Analysis**: Monitor monthly performance and identify seasonal patterns
2. **Customer Retention**: Focus on maintaining relationships with top customers
3. **Sales Diversification**: Consider strategies to reduce dependency on top customers
4. **Growth Opportunities**: Analyze factors contributing to best-performing months

---

```{r cleanup, include=FALSE}
# Close database connection
dbDisconnect(con)
```

---

*Report generated on `r Sys.time()` using R and SQL Server Express*
